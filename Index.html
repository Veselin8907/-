<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<title>–ë–ê–ó–ê –î–ê–ù–ù–ò</title>

<style>
body{
 font-family:Arial;
 background:#ffffff;
 padding:10px;
}

h2{text-align:center}

input,button{
 margin:4px;
 padding:8px;
 border-radius:6px;
 border:1px solid #999;
}

button{cursor:pointer;font-weight:bold}

.btn-add{background:#4CAF50;color:#fff}
.btn-db{background:#2196F3;color:#fff}
.btn-search{background:#607D8B;color:#fff}
.btn-exit{background:#777;color:#fff}
.btn-del{background:#f44336;color:#fff}
.btn-print{background:#9C27B0;color:#fff}
.btn-share{background:#FF9800;color:#fff}

.hidden{display:none}

table{
 border-collapse:collapse;
 width:100%;
 background:#fff;
}

th,td{
 border:1px solid #999;
 padding:6px;
}

th{background:#ddd}

.card{
 max-width:520px;
 margin:auto;
 background:#fff;
 padding:12px;
 border-radius:10px;
 box-shadow:0 4px 10px #0003;
}

.row{display:flex;gap:10px}

.photo{
 width:140px;
 height:180px;
 border:2px solid #555;
 display:flex;
 align-items:center;
 justify-content:center;
 font-size:14px;
}

.photo img{
 width:100%;
 height:100%;
 object-fit:cover;
}

@media print{
 body{background:#fff}
 button,input{display:none}
}
</style>
</head>

<body>

<h2>–ë–ê–ó–ê –î–ê–ù–ù–ò</h2>

<button class="btn-add" onclick="showAdd()">+ –î–æ–±–∞–≤–∏</button>
<button class="btn-db" onclick="showDB()">–ë–∞–∑–∞ –¥–∞–Ω–Ω–∏</button>

<hr>

<input id="q" placeholder="–¢—ä—Ä—Å–µ–Ω–µ –ø–æ –∏–º–µ, –ï–ì–ù –∏–ª–∏ –ú–ü–°">
<button class="btn-search" onclick="doSearch()">–¢—ä—Ä—Å–∏</button>

<hr>

<!-- –î–û–ë–ê–í–Ø–ù–ï -->
<div id="addBox" class="hidden">
<h3>–î–æ–±–∞–≤—è–Ω–µ</h3>

<input id="fname" placeholder="–ò–º–µ">
<input id="mname" placeholder="–ü—Ä–µ–∑–∏–º–µ">
<input id="lname" placeholder="–§–∞–º–∏–ª–∏—è"><br>

<input id="egn" placeholder="–ï–ì–ù">
<input id="birth" placeholder="–î–∞—Ç–∞ –Ω–∞ —Ä–∞–∂–¥–∞–Ω–µ" readonly><br>

<input id="gender" placeholder="–ü–æ–ª"><br>

<input id="city" placeholder="–ì—Ä–∞–¥">
<input id="village" placeholder="–°–µ–ª–æ">
<input id="street" placeholder="–£–ª–∏—Ü–∞"><br>

<input id="reg" placeholder="–†–µ–≥. –Ω–æ–º–µ—Ä –ú–ü–°"><br>

<input type="file" id="photoInput" accept="image/*"><br><br>

<button class="btn-add" onclick="save()">–ó–∞–ø–∞–∑–∏</button>
<button class="btn-exit" onclick="hideAll()">–ò–∑—Ö–æ–¥</button>
</div>

<!-- –ö–ê–†–¢–ê -->
<div id="cardBox" class="hidden"></div>

<!-- –ë–ê–ó–ê –î–ê–ù–ù–ò -->
<div id="dbBox" class="hidden"></div>

<script>
let db = JSON.parse(localStorage.getItem("db")||"[]");
let photoData="";

egn.oninput=function(){
 if(!/^\d{10}$/.test(this.value)){birth.value="";return;}
 let y=+this.value.substr(0,2),
     m=+this.value.substr(2,2),
     d=this.value.substr(4,2),
     year;
 if(m>40){year=2000+y;m-=40}
 else if(m>20){year=1800+y;m-=20}
 else{year=1900+y}
 birth.value=`${d}.${String(m).padStart(2,"0")}.${year}`;
}

photoInput.onchange=e=>{
 if(!e.target.files[0])return;
 const r=new FileReader();
 r.onload=()=>photoData=r.result;
 r.readAsDataURL(e.target.files[0]);
}

function hideAll(){
 addBox.classList.add("hidden");
 cardBox.classList.add("hidden");
 dbBox.classList.add("hidden");
}

function showAdd(){hideAll();addBox.classList.remove("hidden");}

function save(){
 if(!fname.value||!egn.value){
  alert("–ò–º–µ –∏ –ï–ì–ù —Å–∞ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏");
  return;
 }
 db.push({
  fname:fname.value,mname:mname.value,lname:lname.value,
  egn:egn.value,birth:birth.value,gender:gender.value,
  city:city.value,village:village.value,street:street.value,
  reg:reg.value,photo:photoData
 });
 localStorage.setItem("db",JSON.stringify(db));
 alert("–ó–∞–ø–∏—Å—ä—Ç –µ –¥–æ–±–∞–≤–µ–Ω");
 location.reload();
}

function doSearch(){
 const v=q.value.toLowerCase().trim();
 if(!v){alert("–í—ä–≤–µ–¥–∏ –∫—Ä–∏—Ç–µ—Ä–∏–π");return;}
 const i=db.findIndex(r=>
  [r.fname,r.mname,r.lname,r.egn,r.reg]
  .filter(Boolean).join(" ").toLowerCase().includes(v)
 );
 if(i>-1) view(i);
 else alert("–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω –∑–∞–ø–∏—Å");
}

function view(i){
 hideAll();
 const r=db[i];
 let h=`<div class="card"><div class="row">
 <div class="photo">${r.photo?`<img src="${r.photo}">`:"–õ–∏–ø—Å–≤–∞ —Å–Ω–∏–º–∫–∞"}</div>
 <div>`;
 const labels={
  fname:"–ò–º–µ",mname:"–ü—Ä–µ–∑–∏–º–µ",lname:"–§–∞–º–∏–ª–∏—è",
  egn:"–ï–ì–ù",birth:"–î–∞—Ç–∞ –Ω–∞ —Ä–∞–∂–¥–∞–Ω–µ",gender:"–ü–æ–ª",
  city:"–ì—Ä–∞–¥",village:"–°–µ–ª–æ",street:"–£–ª–∏—Ü–∞",reg:"–ú–ü–°"
 };
 for(let k in labels) if(r[k]) h+=`<div><b>${labels[k]}:</b> ${r[k]}</div>`;
 h+=`</div></div><br>
 <button class="btn-exit" onclick="hideAll()">–ò–∑—Ö–æ–¥</button></div>`;
 cardBox.innerHTML=h;
 cardBox.classList.remove("hidden");
}

function showDB(){
 hideAll();
 let h=`<h3>–ë–∞–∑–∞ –¥–∞–Ω–Ω–∏</h3>
 <table><tr><th></th><th>–¢—Ä–∏ –∏–º–µ–Ω–∞</th><th>–ï–ì–ù</th><th></th></tr>`;
 db.forEach((r,i)=>{
  h+=`<tr>
  <td><input type="checkbox" data-i="${i}"></td>
  <td>${r.fname} ${r.mname} ${r.lname}</td>
  <td>${r.egn}</td>
  <td>
   <button onclick="view(${i})">üëÅ</button>
   <button class="btn-del" onclick="del(${i})">üóë</button>
  </td></tr>`;
 });
 h+=`</table><br>

 <button class="btn-print" onclick="window.print()">üñ® –ü—Ä–∏–Ω—Ç–∏—Ä–∞–Ω–µ</button>
 <button class="btn-share" onclick="shareRecords()">üì≤ –°–ø–æ–¥–µ–ª–∏ –∑–∞–ø–∏—Å–∏</button>

 <input type="file" id="importFile" hidden onchange="importRecords(this)">
 <button class="btn-share" onclick="importFile.click()">‚¨á –ò–º–ø–æ—Ä—Ç</button>

 <br><br>
 <button class="btn-exit" onclick="hideAll()">–ò–∑—Ö–æ–¥</button>`;
 dbBox.innerHTML=h;
 dbBox.classList.remove("hidden");
}

function del(i){
 if(!confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?"))return;
 db.splice(i,1);
 localStorage.setItem("db",JSON.stringify(db));
 showDB();
}

async function shareRecords(){
 if(!navigator.share){
  alert("–°–ø–æ–¥–µ–ª—è–Ω–µ –Ω–µ —Å–µ –ø–æ–¥–¥—ä—Ä–∂–∞");
  return;
 }
 const file=new File(
  [JSON.stringify(db,null,2)],
  "records.json",
  {type:"application/json"}
 );
 try{
  await navigator.share({
   title:"–ë–∞–∑–∞ –¥–∞–Ω–Ω–∏",
   text:"–ü—Ä–µ—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –∑–∞–ø–∏—Å–∏",
   files:[file]
  });
 }catch(e){}
}

function importRecords(input){
 const r=new FileReader();
 r.onload=()=>{
  try{
   const data=JSON.parse(r.result);
   data.forEach(x=>db.push(x));
   localStorage.setItem("db",JSON.stringify(db));
   alert("–î–∞–Ω–Ω–∏—Ç–µ —Å–∞ –¥–æ–±–∞–≤–µ–Ω–∏");
   showDB();
  }catch{
   alert("–ù–µ–≤–∞–ª–∏–¥–µ–Ω —Ñ–∞–π–ª");
  }
 };
 r.readAsText(input.files[0]);
}
</script>

</body>
</html>
